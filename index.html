<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gemini TTS Studio v3</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f0f1a;--card:#1a1a2e;--border:#2a2a4a;--pri:#6c5ce7;--pri2:#a29bfe;--acc:#00cec9;--tx:#e0e0e0;--txd:#888;--err:#ff6b6b;--ok:#00b894;--warn:#fdcb6e}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;padding:16px}
.wrap{max-width:1060px;margin:0 auto}
h1{text-align:center;font-size:1.6em;margin-bottom:4px;background:linear-gradient(135deg,var(--pri2),var(--acc));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sub{text-align:center;color:var(--txd);font-size:.82em;margin-bottom:20px}
.c{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:14px}
.ct{font-size:1em;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:7px}
.row{display:flex;gap:10px;flex-wrap:wrap}.col{flex:1;min-width:180px}
label{display:block;font-size:.78em;color:var(--txd);margin-bottom:3px}
input,select,textarea{width:100%;padding:9px 11px;background:#12122a;border:1px solid var(--border);border-radius:7px;color:var(--tx);font-size:.88em;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--pri)}
textarea{resize:vertical;font-family:inherit;line-height:1.6}
.btn{padding:9px 18px;border:none;border-radius:7px;font-size:.88em;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all .2s}
.btn:disabled{opacity:.4;cursor:not-allowed}
.bp{background:var(--pri);color:#fff}.bp:hover:not(:disabled){background:var(--pri2)}
.ba{background:var(--acc);color:#000}.ba:hover:not(:disabled){filter:brightness(1.15)}
.bd{background:var(--err);color:#fff}.bd:hover:not(:disabled){filter:brightness(1.1)}
.bw{background:var(--warn);color:#000}
.bs{padding:5px 12px;font-size:.78em}
.bg{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px}
.rr{display:flex;align-items:center;gap:8px}
.rr input[type=range]{flex:1;accent-color:var(--pri)}
.rv{font-size:.82em;color:var(--acc);min-width:36px;text-align:right}
.stats{display:flex;gap:14px;flex-wrap:wrap;margin:8px 0}
.st{background:#12122a;padding:6px 12px;border-radius:7px;font-size:.78em}
.st b{color:var(--acc)}
.sl{display:flex;flex-direction:column;gap:7px;margin-top:8px}
.sg{background:#12122a;border:1px solid var(--border);border-radius:7px;padding:10px}
.sg.gn{border-color:var(--warn);animation:pu 1.5s infinite}
.sg.dn{border-color:var(--ok)}
.sg.er{border-color:var(--err)}
.sg.flagged{border-color:var(--warn);border-width:2px}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.7}}
.sh{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.sn{font-weight:600;color:var(--pri2);font-size:.85em}
.ss{font-size:.72em;padding:2px 7px;border-radius:4px}
.ss.p{background:#333;color:#999}
.ss.g{background:rgba(253,203,110,.2);color:var(--warn)}
.ss.o{background:rgba(0,184,148,.2);color:var(--ok)}
.ss.e{background:rgba(255,107,107,.2);color:var(--err)}
.ss.f{background:rgba(253,203,110,.3);color:var(--warn)}
.stx{font-size:.78em;color:var(--txd);max-height:50px;overflow:hidden;line-height:1.4}
.sa{margin-top:6px}
.sa audio{width:100%;height:34px}
.sa-info{font-size:.7em;color:var(--txd);margin-top:3px;display:flex;gap:12px}
.sa-info .flag{color:var(--warn);font-weight:600}
.pb{width:100%;height:5px;background:#12122a;border-radius:3px;margin:10px 0;overflow:hidden}
.pf{height:100%;background:linear-gradient(90deg,var(--pri),var(--acc));border-radius:3px;transition:width .3s}
.log{background:#0a0a18;border:1px solid var(--border);border-radius:7px;padding:10px;max-height:200px;overflow-y:auto;font-family:'Courier New',monospace;font-size:.72em;line-height:1.5;margin-top:8px}
.log .i{color:var(--acc)}.log .w{color:var(--warn)}.log .e{color:var(--err)}.log .k{color:var(--ok)}
.fa{margin-top:8px;padding:12px;background:#12122a;border-radius:7px}
.fa audio{width:100%;margin:6px 0}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:700px){.g2,.row{grid-template-columns:1fr;flex-direction:column}}
.hd{display:none}
.mo{display:flex;gap:7px;margin-bottom:8px}
.mi{flex:1;padding:10px;background:#12122a;border:2px solid var(--border);border-radius:7px;cursor:pointer;text-align:center;transition:all .2s}
.mi:hover{border-color:var(--pri)}
.mi.sel{border-color:var(--acc);background:rgba(0,206,201,.08)}
.mi .mn{font-weight:600;font-size:.9em;margin-bottom:1px}
.mi .md{font-size:.7em;color:var(--txd)}
.tip{background:rgba(108,92,231,.1);border-left:3px solid var(--pri);padding:8px 12px;border-radius:0 7px 7px 0;font-size:.78em;color:var(--txd);margin:7px 0;line-height:1.5}
.tip b{color:var(--acc)}
.bible-box{background:rgba(0,206,201,.04);border:1px solid rgba(0,206,201,.15);border-radius:7px;padding:14px;margin-top:8px}
.bible-box textarea{background:#0a0a18}
.sep-tag{display:inline-block;background:var(--pri);color:#fff;padding:1px 8px;border-radius:4px;font-size:.72em;font-family:monospace}
.toggle{display:flex;align-items:center;gap:8px;margin:6px 0}
.toggle input[type=checkbox]{width:16px;height:16px;accent-color:var(--acc)}
.toggle label{margin:0;font-size:.82em;color:var(--tx);cursor:pointer}
.tab-row{display:flex;gap:2px;margin-bottom:10px}
.tab-btn{padding:7px 14px;background:#12122a;border:1px solid var(--border);border-bottom:none;border-radius:7px 7px 0 0;cursor:pointer;font-size:.8em;color:var(--txd)}
.tab-btn.act{background:var(--card);color:var(--tx);font-weight:600;border-color:var(--acc)}
.tab-pan{display:none}.tab-pan.act{display:block}
.regen-btn{padding:3px 10px;font-size:.7em;background:var(--warn);color:#000;border:none;border-radius:4px;cursor:pointer;margin-left:6px}
</style>
</head>
<body>
<div class="wrap">
<h1>ğŸ™ï¸ Gemini TTS Studio v3</h1>
<p class="sub">ë³´ì´ìŠ¤ ë°”ì´ë¸” + ì»¨í…ìŠ¤íŠ¸ ì—°ê²° + í’ˆì§ˆ ê²€ìˆ˜ë¡œ ë¡±í¼ ì¼ê´€ì„± ê·¹ëŒ€í™”</p>

<!-- API ì„¤ì • -->
<div class="c">
<div class="ct">ğŸ”‘ API ì„¤ì •</div>
<div class="tab-row">
<div class="tab-btn act" onclick="apiTab('direct')">Direct API</div>
<div class="tab-btn" onclick="apiTab('supa')">Supabase í”„ë¡ì‹œ</div>
</div>
<div class="tab-pan act" id="tp-direct">
<div class="row">
<div class="col" style="flex:2"><label>Google AI Studio API Key</label><input type="password" id="apiKey" placeholder="AIza..."></div>
<div class="col"><label>&nbsp;</label><button class="btn bs bp" onclick="testApi()">í…ŒìŠ¤íŠ¸</button><span id="apiSt" style="font-size:.78em;margin-left:6px"></span></div>
</div>
</div>
<div class="tab-pan" id="tp-supa">
<div class="row">
<div class="col"><label>Supabase URL</label><input id="supaUrl" placeholder="https://xxx.supabase.co"></div>
<div class="col"><label>Supabase Anon Key</label><input type="password" id="supaKey" placeholder="eyJ..."></div>
</div>
<div style="margin-top:6px"><label>Edge Function ì´ë¦„</label><input id="supaFn" value="tts-proxy" placeholder="tts-proxy"></div>
<div class="tip">ğŸ’¡ Supabase Edge Functionì´ Gemini APIë¥¼ ëŒ€ì‹  í˜¸ì¶œí•©ë‹ˆë‹¤. API í‚¤ê°€ ì„œë²„ì—ë§Œ ì €ì¥ë˜ì–´ ì•ˆì „í•©ë‹ˆë‹¤.</div>
</div>
</div>

<!-- ëª¨ë¸ -->
<div class="c">
<div class="ct">ğŸ¤– ëª¨ë¸ & ìŒì„± (ê³ ì • í•„ìˆ˜)</div>
<div class="g2">
<div><label>TTS ëª¨ë¸</label><select id="mdl">
<option value="gemini-2.5-flash-preview-tts">Flash TTS (ë¹ ë¦„)</option>
<option value="gemini-2.5-pro-preview-tts">Pro TTS (ê³ í’ˆì§ˆ)</option>
</select></div>
<div><label>ìŒì„± (ì „ ì²­í¬ ê³ ì •)</label><select id="vn">
<option value="Zephyr">Zephyr (ë°ê³  í™œê¸°ì°¬)</option><option value="Puck">Puck (í™œë°œí•œ ë‚¨ì„±)</option>
<option value="Charon">Charon (ì°¨ë¶„í•œ ë‚¨ì„±)</option><option value="Kore">Kore (ë¶€ë“œëŸ¬ìš´ ì—¬ì„±)</option>
<option value="Fenrir">Fenrir (ê¹Šì€ ë‚¨ì„±)</option><option value="Leda">Leda (ë”°ëœ»í•œ ì—¬ì„±)</option>
<option value="Orus">Orus (ì¤‘í›„í•œ ë‚¨ì„±)</option><option value="Aoede">Aoede (í¸ì•ˆí•œ ì—¬ì„±)</option>
</select></div>
</div>
<div style="margin-top:8px"><label>ì²­í¬ ê°„ ëŒ€ê¸° (ms)</label>
<div class="rr"><input type="range" id="sd" min="300" max="3000" value="500" step="100" oninput="$('dv').textContent=this.value"><span class="rv" id="dv">500</span></div>
</div>
</div>

<!-- ë³´ì´ìŠ¤ ë°”ì´ë¸” -->
<div class="c">
<div class="ct">ğŸ“– ë³´ì´ìŠ¤ ë°”ì´ë¸” (ì¼ê´€ì„± í•µì‹¬)</div>
<div class="tip" style="margin-bottom:10px">âš ï¸ ì´ ë°”ì´ë¸”ì´ <b>ëª¨ë“  ì²­í¬ì— 100% ë™ì¼í•˜ê²Œ</b> ì ìš©ë©ë‹ˆë‹¤. ë‹¨ì–´ í•˜ë‚˜ë¼ë„ ë°”ë€Œë©´ ê²°ê³¼ê°€ í”ë“¤ë¦½ë‹ˆë‹¤.</div>
<div class="bible-box">
<label>í™”ì ìºë¦­í„° & í†¤ ì„¤ì •</label>
<textarea id="bibleChar" rows="3" placeholder="ë‚˜ì´ëŒ€, ë§íˆ¬, ê°ì •ì„ , ì—ë„ˆì§€ ë ˆë²¨">40ëŒ€ ì¤‘ë°˜ ë‚¨ì„±. ë°˜ë§ í†¤. ê°ì •ì€ ì°¨ë¶„í•˜ë˜ í•µì‹¬ í¬ì¸íŠ¸ì—ì„œë§Œ ì•½ê°„ í˜ì„ ì‹¤ì–´ ê°•ì¡°í•œë‹¤. ì—ë„ˆì§€ ë ˆë²¨ 4/10. ê²½ì œ/ì¬í…Œí¬ ìœ íŠœë¸Œ ì±„ë„ì˜ ì‹ ë¢°ê° ìˆëŠ” ì§„í–‰ì.</textarea>

<label style="margin-top:10px">ì†ë„ & í˜¸í¡ ê·œì¹™</label>
<textarea id="bibleSpeed" rows="3" placeholder="ì½ê¸° ì†ë„, ì‰¼ ê·œì¹™">ë§í•˜ëŠ” ì†ë„ëŠ” ë³´í†µë³´ë‹¤ ì•½ê°„ ëŠë¦¬ê²Œ. ë¬¸ì¥ ëë§ˆë‹¤ 0.2ì´ˆ ì‰¬ê³ , ìƒˆë¡œìš´ ì£¼ì œ ì‹œì‘ ì „ì—ëŠ” 0.4ì´ˆ ì‰°ë‹¤. ìˆ«ìë‚˜ í¼ì„¼íŠ¸ë¥¼ ë§í•  ë•ŒëŠ” ë˜ë°•ë˜ë°• ì²œì²œíˆ. ì ˆëŒ€ ê¸‰ê°€ì†í•˜ì§€ ì•ŠëŠ”ë‹¤. ë§ˆì§€ë§‰ ë¬¸ì¥ë„ ì²˜ìŒê³¼ ê°™ì€ ì†ë„ë¡œ ëë‚¸ë‹¤.</textarea>

<label style="margin-top:10px">ë°œìŒ ì‚¬ì „ (ê³ ìœ ëª…ì‚¬/ìˆ«ì/ì•½ì–´)</label>
<textarea id="bibleDict" rows="3" placeholder="íŠ¹ìˆ˜ ì½ê¸° ê·œì¹™">CPIëŠ” "ì”¨í”¼ì•„ì´"ë¡œ, ETFëŠ” "ì´í‹°ì—í”„"ë¡œ, GDPëŠ” "ì§€ë””í”¼"ë¡œ, BISëŠ” "ë¹„ì•„ì´ì—ìŠ¤"ë¡œ ì½ëŠ”ë‹¤. í¼ì„¼íŠ¸ëŠ” "í”„ë¡œ"ê°€ ì•„ë‹ˆë¼ "í¼ì„¼íŠ¸"ë¡œ. 1,500ì›ì€ "ì²œì˜¤ë°±ì›"ìœ¼ë¡œ. ë‹¬ëŸ¬ëŠ” "ë‹¬ëŸ¬"ë¡œ.</textarea>

<label style="margin-top:10px">ê¸ˆì§€ ê·œì¹™</label>
<textarea id="bibleBan" rows="2" placeholder="í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒë“¤">ê³¼ì¥ëœ ê°íƒ„ì´ë‚˜ "ì™€~" ê°™ì€ ì¶”ì„ìƒˆ ê¸ˆì§€. ì›ƒìŒì†Œë¦¬ ê¸ˆì§€. ë ìŒì´ ì²˜ì§€ê±°ë‚˜ ì˜¬ë¼ê°€ì§€ ì•Šê²Œ ì¼ì •í•˜ê²Œ ìœ ì§€. ë§ˆì§€ë§‰ ë¬¸ì¥ì—ì„œ ê¸‰í•˜ê²Œ ë§ˆë¬´ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ëŒ€ê´„í˜¸ [] ì•ˆì˜ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ì†Œë¦¬ë‚´ì–´ ì½ì§€ ë§ê³  í†¤/ê°ì • ì°¸ê³ ë§Œ í•œë‹¤.</textarea>
</div>
</div>

<!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
<div class="c">
<div class="ct">ğŸ“ ëŒ€ë³¸ ì…ë ¥</div>
<div class="tip" style="margin-bottom:8px">âœï¸ ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë‚˜ëˆŒ ê³³ì— <span class="sep-tag">===</span> ë¥¼ í•œ ì¤„ì— ë„£ìœ¼ì„¸ìš”. ê° ì²­í¬ ì•ì— <b>[ì»¨í…ìŠ¤íŠ¸]</b>ë¥¼ ë„£ìœ¼ë©´ ì½ì§€ ì•Šê³  í†¤ ì°¸ê³ ë§Œ í•©ë‹ˆë‹¤.</div>
<textarea id="tx" rows="14" placeholder="[ì´ì „: ì¸íŠ¸ë¡œ. ì°¨ë¶„í•œ ì¸ì‚¬. ì†ë„ ë³´í†µ]
[ì´ë²ˆ: ë³¸ë¡  ì§„ì…. ì°¨ë¶„ ìœ ì§€. í•µì‹¬ ë°ì´í„° ë˜ë°•ë˜ë°•]
ì˜¬í•´ í™˜ìœ¨ ì „ë§ì„ ë³¸ê²©ì ìœ¼ë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
ë¨¼ì € ë‹¬ëŸ¬ ì¸ë±ìŠ¤ë¶€í„° ë³´ë©´...
===
[ì´ì „: í™˜ìœ¨ ì „ë§ ë°ì´í„° ì„¤ëª…. ì°¨ë¶„í•œ í†¤]
[ì´ë²ˆ: íˆ¬ì ì „ëµìœ¼ë¡œ ì „í™˜. ì•½ê°„ í˜ ì‹¤ì–´ ê°•ì¡°]
ê·¸ë ‡ë‹¤ë©´ ìš°ë¦¬ëŠ” ì–´ë–»ê²Œ ëŒ€ì‘í•´ì•¼ í• ê¹Œìš”?
ì²« ë²ˆì§¸ ì „ëµì€..." oninput="uSt()"></textarea>
<div style="margin-top:6px"><input type="file" accept=".txt,.md" onchange="lf(event)" style="font-size:.8em"></div>
<div class="stats">
<div class="st">ê¸€ì: <b id="s1">0</b></div>
<div class="st">ì²­í¬: <b id="s2">0</b></div>
</div>
<div class="bg">
<button class="btn bp" onclick="pvSp()">ğŸ” ë¶„í•  ë¯¸ë¦¬ë³´ê¸°</button>
<button class="btn ba" onclick="go()" id="btnGo">ğŸš€ TTS ìƒì„±</button>
<button class="btn bd bs hd" onclick="doStop()" id="btnSt">â¹ ì¤‘ì§€</button>
</div>
</div>

<!-- ì„¸ê·¸ë¨¼íŠ¸ -->
<div class="c hd" id="segC">
<div class="ct">ğŸ“Š ì²­í¬ í˜„í™©</div>
<div class="pb"><div class="pf" id="pf" style="width:0%"></div></div>
<div style="display:flex;justify-content:space-between;font-size:.78em;color:var(--txd)"><span id="pt">ëŒ€ê¸°</span><span id="pp">0%</span></div>
<div class="sl" id="sL"></div>
</div>

<!-- ê²°ê³¼ -->
<div class="c hd" id="resC">
<div class="ct">ğŸµ ê²°ê³¼</div>
<div id="fS"></div>
<div class="bg" style="justify-content:center;margin-top:10px">
<button class="btn ba" onclick="dlAll()">ğŸ“¥ ê°œë³„ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn bp" onclick="merge()">ğŸ”— ë³‘í•© ë‹¤ìš´ë¡œë“œ (í¬ë¡œìŠ¤í˜ì´ë“œ+ì •ê·œí™”)</button>
</div>
</div>

<!-- ë¡œê·¸ -->
<div class="c"><div class="ct">ğŸ“‹ ë¡œê·¸</div><div class="log" id="lg"></div></div>
</div>

<script>
const $=id=>document.getElementById(id);
const lg=(m,c='i')=>{const d=$('lg');d.innerHTML+=`<div class="${c}">[${new Date().toLocaleTimeString('ko-KR')}] ${m}</div>`;d.scrollTop=d.scrollHeight};

let ST={segs:[],auds:[],running:false,stop:false,apiMode:'direct'};

function apiTab(m){
  ST.apiMode=m;
  document.querySelectorAll('.tab-btn').forEach((e,i)=>{e.classList.toggle('act',i===(m==='direct'?0:1))});
  $('tp-direct').classList.toggle('act',m==='direct');
  $('tp-supa').classList.toggle('act',m==='supa');
}

function uSt(){
  const t=$('tx').value,segs=splitManual(t);
  $('s1').textContent=t.length.toLocaleString();
  $('s2').textContent=segs.length;
}
function lf(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=v=>{$('tx').value=v.target.result;uSt();lg('íŒŒì¼: '+f.name,'k')};r.readAsText(f)}

async function testApi(){
  const k=$('apiKey').value.trim();if(!k){$('apiSt').textContent='âŒ';return}
  try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${k}`);
    $('apiSt').innerHTML=r.ok?'<span style="color:var(--ok)">âœ…</span>':'<span style="color:var(--err)">âŒ</span>';
    lg(r.ok?'API OK':'API ì‹¤íŒ¨',r.ok?'k':'e');
  }catch(e){$('apiSt').innerHTML='âŒ';lg(e.message,'e')}
}

// ===== ë³´ì´ìŠ¤ ë°”ì´ë¸” ì¡°í•© =====
function buildBible(){
  const parts=[];
  const ch=$('bibleChar').value.trim();if(ch)parts.push(`[í™”ì ìºë¦­í„°]\n${ch}`);
  const sp=$('bibleSpeed').value.trim();if(sp)parts.push(`[ì†ë„/í˜¸í¡ ê·œì¹™]\n${sp}`);
  const di=$('bibleDict').value.trim();if(di)parts.push(`[ë°œìŒ ì‚¬ì „]\n${di}`);
  const bn=$('bibleBan').value.trim();if(bn)parts.push(`[ê¸ˆì§€ ê·œì¹™]\n${bn}`);
  return parts.join('\n\n');
}

// ===== ë¶„í•  =====
function splitManual(text){
  return text.trim().split(/\n\s*===\s*\n/).map(s=>s.trim()).filter(s=>s.length>0);
}

function pvSp(){
  const t=$('tx').value.trim();if(!t){alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  ST.segs=splitManual(t);if(!ST.segs.length){alert('ì„¸ê·¸ë¨¼íŠ¸ ì—†ìŒ');return}
  rnSg();$('segC').classList.remove('hd');
  lg(`ë¶„í• : ${ST.segs.length}ê°œ ì²­í¬`,'k');
  ST.segs.forEach((s,i)=>lg(`  #${i+1}: ${s.length}ì`));
}

function rnSg(){
  const l=$('sL');l.innerHTML='';
  ST.segs.forEach((s,i)=>{
    const preview=s.replace(/\[.*?\]/g,'').trim().substring(0,120);
    const d=document.createElement('div');d.className='sg';d.id='sg'+i;
    d.innerHTML=`<div class="sh"><span class="sn">ì²­í¬ ${i+1}/${ST.segs.length}</span><span class="ss p" id="ss${i}">ëŒ€ê¸°</span></div><div class="stx">${preview}${preview.length>=120?'...':''} <span style="color:var(--acc)">(${s.length}ì)</span></div><div class="sa" id="sa${i}"></div>`;
    l.appendChild(d);
  });
}

// ===== PCM â†’ WAV =====
function pcmToWav(pcm,sr,ch,bps){
  const br=sr*ch*(bps/8),ba=ch*(bps/8),ds=pcm.byteLength;
  const buf=new ArrayBuffer(44+ds),v=new DataView(buf);
  const w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};
  w(0,'RIFF');v.setUint32(4,36+ds,true);w(8,'WAVE');w(12,'fmt ');
  v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,ch,true);
  v.setUint32(24,sr,true);v.setUint32(28,br,true);v.setUint16(32,ba,true);
  v.setUint16(34,bps,true);w(36,'data');v.setUint32(40,ds,true);
  new Uint8Array(buf,44).set(new Uint8Array(pcm));
  return buf;
}

function b64ToWavBlob(b64){
  const raw=atob(b64),bytes=new Uint8Array(raw.length);
  for(let i=0;i<raw.length;i++)bytes[i]=raw.charCodeAt(i);
  if(bytes.length>4&&bytes[0]===0x52&&bytes[1]===0x49&&bytes[2]===0x46&&bytes[3]===0x46){
    return new Blob([bytes],{type:'audio/wav'});
  }
  return new Blob([pcmToWav(bytes.buffer,24000,1,16)],{type:'audio/wav'});
}

// ===== í’ˆì§ˆ ê²€ìˆ˜ =====
function analyzeWav(blob){
  return new Promise(async(res)=>{
    const ab=await blob.arrayBuffer();
    const dv=new DataView(ab);
    if(dv.getUint32(0)!==0x52494646){res({ok:true,flags:[]});return}
    const sr=dv.getUint32(24,true),bps=dv.getUint16(34,true),nc=dv.getUint16(22,true);
    const dataStart=44,dataLen=ab.byteLength-dataStart;
    const samples=dataLen/(bps/8);
    const duration=samples/(sr*nc);
    // RMS ê³„ì‚°
    let sumSq=0,silentSamples=0,peak=0;
    const view=new Int16Array(ab,dataStart);
    for(let i=0;i<view.length;i++){
      const v=view[i]/32768;
      sumSq+=v*v;
      if(Math.abs(v)<0.01)silentSamples++;
      if(Math.abs(v)>peak)peak=Math.abs(v);
    }
    const rms=Math.sqrt(sumSq/view.length);
    const silentRatio=silentSamples/view.length;
    // ë§ˆì§€ë§‰ 1ì´ˆ ì—ë„ˆì§€
    const lastSecSamples=Math.min(sr,view.length);
    let lastSumSq=0;
    for(let i=view.length-lastSecSamples;i<view.length;i++){
      const v=view[i]/32768;lastSumSq+=v*v;
    }
    const lastRms=Math.sqrt(lastSumSq/lastSecSamples);
    // íŒì •
    const flags=[];
    if(rms<0.005)flags.push('âš ï¸ ì „ì²´ ìŒëŸ‰ ë§¤ìš° ë‚®ìŒ (ë¬´ìŒ?)');
    if(silentRatio>0.7)flags.push('âš ï¸ ë¬´ìŒ êµ¬ê°„ 70%+ ì´ˆê³¼');
    if(duration<1&&text_len>50)flags.push('âš ï¸ ë¹„ì •ìƒì ìœ¼ë¡œ ì§§ì€ ì˜¤ë””ì˜¤');
    if(lastRms<rms*0.15&&duration>5)flags.push('âš ï¸ ëë¶€ë¶„ ê¸‰ê²©íˆ ì¡°ìš©í•´ì§');
    if(lastRms>rms*3.5&&duration>5)flags.push('âš ï¸ ëë¶€ë¶„ ê¸‰ê²©íˆ ì»¤ì§');
    // ì†ë„ ì¶”ì • (í•œê¸€ ì•½ 4ì/ì´ˆ ê¸°ì¤€, í° í¸ì°¨ ê°ì§€)
    res({ok:flags.length===0,flags,duration:duration.toFixed(1),rms:rms.toFixed(4),silentRatio:(silentRatio*100).toFixed(1)});
  });
}

// ===== API í˜¸ì¶œ =====
async function callTTS(bible,scriptText,voiceName){
  const genConfig={
    responseModalities:["AUDIO"],
    speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName}}}
  };

  // ë°”ì´ë¸”ì€ ëŒ€ë³¸ì— ì§ì ‘ í¬í•¨í•˜ë˜, ì ˆëŒ€ ì½ì§€ ì•Šë„ë¡ ëª…ì‹œì  êµ¬ë¶„
  let finalText=scriptText;
  if(bible){
    finalText=`ì•„ë˜ [ì‹œìŠ¤í…œ ì§€ì‹œ]ëŠ” ì ˆëŒ€ ì†Œë¦¬ë‚´ì–´ ì½ì§€ ë§ˆì„¸ìš”. ìŒì„±ì˜ ìŠ¤íƒ€ì¼ê³¼ í†¤ì„ ì •í•˜ëŠ” ì°¸ê³  ì‚¬í•­ì¼ ë¿ì…ë‹ˆë‹¤. ì†Œë¦¬ë‚´ì–´ ì½ì–´ì•¼ í•  ë¶€ë¶„ì€ [ëŒ€ë³¸ ì‹œì‘] ì´í›„ì˜ í…ìŠ¤íŠ¸ë§Œì…ë‹ˆë‹¤.\n\n[ì‹œìŠ¤í…œ ì§€ì‹œ]\n${bible}\n[ì‹œìŠ¤í…œ ì§€ì‹œ ë]\n\n[ëŒ€ë³¸ ì‹œì‘]\n${scriptText}\n[ëŒ€ë³¸ ë]`;
  }

  const body={
    generationConfig:genConfig,
    contents:[{parts:[{text:finalText}]}]
  };

  if(ST.apiMode==='supa'){
    const url=`${$('supaUrl').value.trim()}/functions/v1/${$('supaFn').value.trim()}`;
    const r=await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${$('supaKey').value.trim()}`},
      body:JSON.stringify({body,model:$('mdl').value})
    });
    if(!r.ok)throw new Error(`Supabase ${r.status}: ${(await r.text()).substring(0,150)}`);
    return await r.json();
  }else{
    const k=$('apiKey').value.trim();
    const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${$('mdl').value}:generateContent?key=${k}`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
    });
    if(!r.ok)throw new Error(`API ${r.status}: ${(await r.text()).substring(0,150)}`);
    return await r.json();
  }
}

async function genSeg(text,i){
  const vn=$('vn').value,bible=buildBible();
  const el=$('sg'+i),ss=$('ss'+i);
  ss.textContent='ìƒì„± ì¤‘...';ss.className='ss g';el.className='sg gn';

  // ë°”ì´ë¸”ì€ systemInstructionìœ¼ë¡œ ë¶„ë¦¬, ëŒ€ë³¸ë§Œ contentsë¡œ ì „ì†¡
  lg(`  ì‹œìŠ¤í…œì§€ì‹œ(${bible.length}ì) + ëŒ€ë³¸(${text.length}ì) ì „ì†¡`);

  const d=await callTTS(bible,text,vn);
  if(!d.candidates?.[0]?.content?.parts)throw new Error('ì‘ë‹µì— ì˜¤ë””ì˜¤ ì—†ìŒ');
  const ap=d.candidates[0].content.parts.find(p=>p.inlineData);
  if(!ap)throw new Error('ì˜¤ë””ì˜¤ íŒŒíŠ¸ ì—†ìŒ');

  let blob=b64ToWavBlob(ap.inlineData.data);
  lg(`  ì›ë³¸: ${(blob.size/1024).toFixed(0)}KB`);

  // í’ˆì§ˆ ê²€ìˆ˜
  const qa=await analyzeWav(blob,text.replace(/\[.*?\]/g,'').length);
  lg(`  QA: ${qa.duration}ì´ˆ | RMS:${qa.rms} | ë¬´ìŒ:${qa.silentRatio}%`);

  ss.textContent='ì™„ë£Œ âœ“';ss.className='ss o';el.className='sg dn';
  const au=URL.createObjectURL(blob);
  let infoHtml=`<span>${qa.duration}ì´ˆ | ${(blob.size/1024).toFixed(0)}KB</span>`;

  if(!qa.ok){
    el.className='sg flagged';ss.textContent='âš ï¸ ê²€í† ';ss.className='ss f';
    infoHtml+=qa.flags.map(f=>`<span class="flag">${f}</span>`).join('');
    infoHtml+=`<button class="regen-btn" onclick="regenSeg(${i})">ğŸ”„ ì¬ìƒì„±</button>`;
    lg(`  âš ï¸ ì´ìƒ ê°ì§€: ${qa.flags.join(', ')}`,'w');
  }

  $('sa'+i).innerHTML=`<audio controls src="${au}"></audio><div class="sa-info">${infoHtml}</div>`;
  return{blob,url:au,qa};
}

async function regenSeg(i){
  lg(`ì²­í¬ ${i+1} ì¬ìƒì„±...`,'w');
  try{
    const res=await genSeg(ST.segs[i],i);
    ST.auds[i]=res;
    lg(`ì²­í¬ ${i+1} ì¬ìƒì„± ì™„ë£Œ âœ“`,'k');
  }catch(e){lg(`ì¬ìƒì„± ì‹¤íŒ¨: ${e.message}`,'e')}
}

async function go(){
  const hasKey=ST.apiMode==='direct'?$('apiKey').value.trim():$('supaUrl').value.trim();
  if(!hasKey){alert(ST.apiMode==='direct'?'API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”':'Supabase URLì„ ì…ë ¥í•˜ì„¸ìš”');return}
  const t=$('tx').value.trim();if(!t){alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return}
  ST.segs=splitManual(t);if(!ST.segs.length){alert('ì„¸ê·¸ë¨¼íŠ¸ ì—†ìŒ');return}
  ST.auds=new Array(ST.segs.length).fill(null);ST.running=true;ST.stop=false;
  rnSg();$('segC').classList.remove('hd');$('resC').classList.add('hd');
  $('btnGo').classList.add('hd');$('btnSt').classList.remove('hd');
  lg(`===== ìƒì„± ì‹œì‘ =====`,'i');
  lg(`ëª¨ë¸: ${$('mdl').value} | ìŒì„±: ${$('vn').value} | ${ST.segs.length}ì²­í¬ | ${ST.apiMode}`);
  const dl=+$('sd').value;let done=0;
  for(let i=0;i<ST.segs.length;i++){
    if(ST.stop){lg('ì¤‘ì§€ë¨','w');break}
    lg(`ì²­í¬ ${i+1}/${ST.segs.length} (${ST.segs[i].length}ì)...`);
    try{
      ST.auds[i]=await genSeg(ST.segs[i],i);done++;
      const pct=Math.round(done/ST.segs.length*100);
      $('pf').style.width=pct+'%';$('pt').textContent=`${done}/${ST.segs.length}`;$('pp').textContent=pct+'%';
      lg(`ì²­í¬ ${i+1} ì™„ë£Œ âœ“`,'k');
      if(i<ST.segs.length-1&&!ST.stop)await new Promise(r=>setTimeout(r,dl));
    }catch(e){
      lg(`ì²­í¬ ${i+1} ì˜¤ë¥˜: ${e.message}`,'e');
      $('ss'+i).textContent='ì˜¤ë¥˜';$('ss'+i).className='ss e';$('sg'+i).className='sg er';
      await new Promise(r=>setTimeout(r,2000));
      try{
        lg(`ì¬ì‹œë„...`,'w');ST.auds[i]=await genSeg(ST.segs[i],i);done++;
        const pct=Math.round(done/ST.segs.length*100);
        $('pf').style.width=pct+'%';$('pt').textContent=`${done}/${ST.segs.length}`;$('pp').textContent=pct+'%';
        lg(`ì¬ì‹œë„ ì„±ê³µ âœ“`,'k');
        if(i<ST.segs.length-1&&!ST.stop)await new Promise(r=>setTimeout(r,dl));
      }catch(e2){lg(`ì¬ì‹œë„ ì‹¤íŒ¨: ${e2.message}`,'e')}
    }
  }
  ST.running=false;$('btnGo').classList.remove('hd');$('btnSt').classList.add('hd');
  const ok=ST.auds.filter(Boolean).length;
  if(ok>0){$('resC').classList.remove('hd');showRes();lg(`===== ì™„ë£Œ: ${ok}/${ST.segs.length} ì„±ê³µ =====`,'k')}
  else lg('ìƒì„± ì‹¤íŒ¨','e');
}

function doStop(){ST.stop=true;lg('ì¤‘ì§€ ìš”ì²­...','w')}

function showRes(){
  const fs=$('fS');fs.innerHTML='';
  ST.auds.forEach((a,i)=>{
    if(!a)return;
    const preview=ST.segs[i]?.replace(/\[.*?\]/g,'').trim().substring(0,30)||'';
    const d=document.createElement('div');d.className='fa';
    d.innerHTML=`<div style="font-size:.85em;margin-bottom:4px;font-weight:600">ì²­í¬ ${i+1} <span style="color:var(--txd);font-weight:400;font-size:.85em">${preview}...</span></div><audio controls src="${a.url}" style="width:100%"></audio>`;
    fs.appendChild(d);
  });
}

function dlAll(){
  ST.auds.forEach((a,i)=>{
    if(!a)return;
    const lk=document.createElement('a');lk.href=a.url;lk.download=`chunk_${String(i+1).padStart(2,'0')}.wav`;
    document.body.appendChild(lk);lk.click();document.body.removeChild(lk);
  });lg('ê°œë³„ ë‹¤ìš´ë¡œë“œ','k');
}

async function merge(){
  lg('ë³‘í•© ì‹œì‘ (í¬ë¡œìŠ¤í˜ì´ë“œ+ì •ê·œí™”)...','i');
  const va=ST.auds.filter(Boolean);
  if(!va.length){lg('ë³‘í•©í•  ì˜¤ë””ì˜¤ ì—†ìŒ','e');return}
  const chunks=[];let sr=24000,nc=1,bps=16;
  for(let i=0;i<va.length;i++){
    const ab=await va[i].blob.arrayBuffer();
    const dv=new DataView(ab);
    if(dv.getUint32(0)===0x52494646){
      sr=dv.getUint32(24,true);nc=dv.getUint16(22,true);bps=dv.getUint16(34,true);
      chunks.push(new Int16Array(ab.slice(44)));
    }
  }
  if(!chunks.length){lg('PCM ì¶”ì¶œ ì‹¤íŒ¨','e');return}

  // ë¼ìš°ë“œë‹ˆìŠ¤ ì •ê·œí™”: ê° ì²­í¬ RMSë¥¼ íƒ€ê²Ÿì— ë§ì¶¤
  const targetRms=0.08;
  const normalized=chunks.map(ch=>{
    let sum=0;for(let i=0;i<ch.length;i++){const v=ch[i]/32768;sum+=v*v}
    const rms=Math.sqrt(sum/ch.length);
    const gain=rms>0.001?targetRms/rms:1;
    const out=new Int16Array(ch.length);
    for(let i=0;i<ch.length;i++){out[i]=Math.max(-32768,Math.min(32767,Math.round(ch[i]*gain)))}
    return out;
  });
  lg(`  ì •ê·œí™” ì™„ë£Œ (íƒ€ê²Ÿ RMS: ${targetRms})`);

  // í¬ë¡œìŠ¤í˜ì´ë“œ ë³‘í•© (80ms)
  const fadeSamples=Math.floor(sr*0.08);
  const gapSamples=Math.floor(sr*0.25); // 250ms gap
  let totalLen=0;
  normalized.forEach((c,i)=>{
    totalLen+=c.length;
    if(i<normalized.length-1)totalLen+=gapSamples;
  });
  const merged=new Int16Array(totalLen);
  let off=0;
  normalized.forEach((c,idx)=>{
    for(let i=0;i<c.length;i++){
      let s=c[i];
      // í˜ì´ë“œì¸ (ì²« ì²­í¬ ì œì™¸)
      if(idx>0&&i<fadeSamples)s=Math.round(s*(i/fadeSamples));
      // í˜ì´ë“œì•„ì›ƒ (ë§ˆì§€ë§‰ ì²­í¬ ì œì™¸)
      if(idx<normalized.length-1&&i>=c.length-fadeSamples)s=Math.round(s*((c.length-i)/fadeSamples));
      merged[off+i]=s;
    }
    off+=c.length;
    if(idx<normalized.length-1)off+=gapSamples; // gapì€ 0(ë¬´ìŒ)
  });

  const wavBuf=pcmToWav(merged.buffer,sr,nc,bps);
  const blob=new Blob([wavBuf],{type:'audio/wav'});
  const lk=document.createElement('a');lk.href=URL.createObjectURL(blob);lk.download='merged_tts.wav';
  document.body.appendChild(lk);lk.click();document.body.removeChild(lk);
  lg(`ë³‘í•© ì™„ë£Œ: ${chunks.length}ì²­í¬ â†’ ${(blob.size/1024/1024).toFixed(1)}MB (í¬ë¡œìŠ¤í˜ì´ë“œ 80ms, ì •ê·œí™” ì ìš©)`,'k');
}

$('tx').addEventListener('input',uSt);
</script>
</body>
</html>